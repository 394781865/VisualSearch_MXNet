<html>

<head>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Visual Search MXNet</title>
    <link rel="icon" 
      type="image/png" 
      href="/assets/images/search.png">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular-animate.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular-aria.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.7/angular-messages.min.js"></script>
    <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/t-114/svg-assets-cache.js"></script>
    <script src="https://cdn.gitcdn.link/cdn/angular/bower-material/v1.1.8/angular-material.js"></script>
    <link href="https://cdn.gitcdn.link/cdn/angular/bower-material/v1.1.8/angular-material.css" rel="stylesheet"/>
    <link href="https://material.angularjs.org/1.1.8/docs.css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="assets/js/ng-file-upload.min.js"></script>
    <script src="assets/js/ng-file-upload-shim.min.js"></script>
    <script src="assets/js/ui-cropper.js"></script>
    <link rel="stylesheet" type="text/css" href="/assets/css/ui-cropper.css"/>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/assets/css/styles.css"/>
    <style>


        .example-card {
            max-width: 400px;
        }

        md-card md-card-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 3px;
            padding-left: 10px;
            padding-right: 5px;
        }
        md-card {
            width: 280px;
        }
        .md-card-image {
            max-height: 200px;
            max-width: 100%;
            margin:auto;
        }
        md-card-content {
            margin: auto;
            padding: 5px;
        }
        h4 {
            overflow:hidden;
            text-overflow: ellipsis;
        }
        md-card-actions {
            padding: 0;
        }


    </style>
</head>

<body>
<div ng-app="fileUpload" mat-app-background basic-container id="appContainer" ng-controller="fileController">
    <form id="myForm" name="myForm">
        <div ngf-drop ngf-drag="drag($isDragging, $class, $event)" id="dropArea" ng-model="picFile"
             ngf-pattern="image/*" class="cropArea">
            <div id="textInfo" class="centered"><span id="textInfoText">Drop image or upload</span>
                <div ngf-select ng-model="picFile" ngf-capture="'camera'" accept="image/*">
                    <svg id="uploadIcon" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100;" xml:space="preserve"><path d="M50,40c-8.285,0-15,6.718-15,15c0,8.285,6.715,15,15,15c8.283,0,15-6.715,15-15,C65,46.718,58.283,40,50,40z M90,25H78c-1.65,0-3.428-1.28-3.949-2.846l-3.102-9.309C70.426,11.28,68.65,10,67,10H33,c-1.65,0-3.428,1.28-3.949,2.846l-3.102,9.309C25.426,23.72,23.65,25,22,25H10C4.5,25,0,29.5,0,35v45c0,5.5,4.5,10,10,10h80,c5.5,0,10-4.5,10-10V35C100,29.5,95.5,25,90,25z M50,80c-13.807,0-25-11.193-25-25c0-13.806,11.193-25,25-25,c13.805,0,25,11.194,25,25C75,68.807,63.805,80,50,80z M86.5,41.993c-1.932,0-3.5-1.566-3.5-3.5c0-1.932,1.568-3.5,3.5-3.5,c1.934,0,3.5,1.568,3.5,3.5C90,40.427,88.433,41.993,86.5,41.993z"/></svg>
                </div
                >
            </div>
        </div>
        <span class="progress" ng-show="progress >= 0">
                <div id="loadingProgress" style="width:{{progress}}%" ng-bind="progress + '%'"></div>
            </span>
        <span ng-show="result">Upload Successful</span>
        <span class="err" ng-show="errorMsg">{{errorMsg}}</span>
    </form>
    <ui-cropper id="cropper" image="picFile  | ngfDataUrl" area-type="rectangle" on-load-begin='resetCanvasHeight()'
                on-load-done='onLoadDone()' on-change='onImageUpdated()' result-image="croppedDataUrl"
                ng-init="croppedDataUrl=''"></ui-cropper>

    <md-content class="md-padding" layout-xs="column" layout="row" layout-wrap>
            <md-card ng-repeat="pred in predictions" md-theme="{{ showDarkTheme ? 'dark-grey' : 'default' }}" md-theme-watch="">
                <md-card-title>
                       <h4>{{pred.title}}</h4>
                </md-card-title>
                <md-card-content>
                    <img ng-src="{{pred.url}}" class="md-card-image" alt="Washed Out">
                </md-card-content>
                <md-card-actions layout="row" layout-align="end left">
                    <md-button>${{pred.price}}</md-button>
                    <md-button><img ng-repeat="i in range() track by $index" src="star-icon.png" width="30"></md-button>
                </md-card-actions>
            </md-card>
        </div>
    </md-content>
</div>
</body>
<script>
    //inject ngFileUpload and ngImgCrop directives and services.
    var app = angular.module('fileUpload', ['ngMaterial', 'ngMessages', 'material.svgAssetsCache',
        'ngFileUpload', 'uiCropper']);
    app.controller('fileController', ['$scope', '$http', '$timeout', '$httpParamSerializerJQLike', 
        function ($scope, $http, $timeout, $httpParamSerializerJQLike) {
            $scope.upload = function (dataUrl) {
                if (dataUrl) {
                    $http({
                        method: 'POST',
                        url: 'https://api.thomasdelteil.com/visualsearch/predict',                    
                        data: $httpParamSerializerJQLike({data: JSON.stringify([dataUrl])}),
                        headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    }).then(function (response) {
                        $timeout(function () {
                            $scope.predictions = response.data.prediction;
                            console.log($scope.result);
                        });
                    }, function (response) {
                        if (response.status > 0) $scope.errorMsg = response.status
                            + ': ' + response.data;
                    }, function (evt) {
                        $scope.progress = parseInt(100.0 * evt.loaded / evt.total);
                    });
                }
            }

            $scope.drag = function ($isDragging, $class, $event) {
                console.log($isDragging, $class, $event);
                if ($isDragging) {
                    $('#dropArea').addClass('draggedOver');
                    $('#textInfo').addClass('draggedOver');
                    $('#uploadIcon').addClass('draggedOver');
                } else {
                    $scope.removeClasses();
                }
            }

            $scope.removeClasses = function () {
                $('#dropArea').removeClass('draggedOver');
                $('#textInfo').removeClass('draggedOver');
                $('#uploadIcon').removeClass('draggedOver');
            }

            $scope.onImageUpdated = function () {
                console.log('called me');
                $('#cropper').height($('#cropper canvas')[0].height);
                $('#cropper canvas').css('visibility', 'visible');
                $('#cropper').css('background-color', 'rgba(0,0,0,0.5)');
                $('#dropArea').height(60);
                $scope.removeClasses();
                $timeout(function () {
                    $scope.upload($scope.croppedDataUrl)
                }, 200);

            }

            $scope.onLoadDone = function () {
                $scope.removeClasses();
                console.log($scope.croppedDataUrl);

            }

            $scope.resetCanvasHeight = function () {
                console.log('did I reset');
                $('#cropper').height(Math.max($(window).width(), 400));
            }

            $scope.range = function() {
                return new Array(4);
            };

            $(function () {
                $('#cropper').css('max-height', Math.min(400, $(window).width()));
            });
    }])
    .config(function ($mdThemingProvider) {
        $mdThemingProvider.theme('dark-grey').backgroundPalette('grey').dark();
        $mdThemingProvider.theme('dark-orange').backgroundPalette('orange').dark();
        $mdThemingProvider.theme('dark-purple').backgroundPalette('deep-purple').dark();
        $mdThemingProvider.theme('dark-blue').backgroundPalette('blue').dark();
    });
</script>

</html>